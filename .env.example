# .env.example
# OpenAI APIè¨­å®š
OPENAI_API_KEY=your_openai_api_key_here

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
DATABASE_URL=postgresql://postgres:postgres@db:5432/research_lab_finder
POSTGRES_DB=research_lab_finder
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
ENVIRONMENT=development
DEBUG=true

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­å®š
VITE_API_BASE_URL=http://localhost:8000

# === ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã® .gitignore ===
# .gitignore

# ç’°å¢ƒå¤‰æ•°
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# ä¾å­˜é–¢ä¿‚
node_modules/
__pycache__/
*.py[cod]
*$py.class

# ãƒ“ãƒ«ãƒ‰æˆæœç‰©
/backend/dist/
/frontend/dist/
/frontend/build/
*.egg-info/
.pytest_cache/

# IDEè¨­å®š
.vscode/
.idea/
*.swp
*.swo
*~

# OSç”Ÿæˆãƒ•ã‚¡ã‚¤ãƒ«
.DS_Store
.DS_Store?
._*
.Spotlight-V100
.Trashes
ehthumbs.db
Thumbs.db

# ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«
*.log
logs/

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
*.db
*.sqlite3
*.sqlite

# ãƒ†ã‚¹ãƒˆ
coverage/
.nyc_output/
.coverage

# Docker
.docker/

# ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«
tmp/
temp/

# === ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
# scripts/setup.sh
#!/bin/bash

set -e

echo "ğŸš€ ç ”ç©¶å®¤ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é–‹å§‹"

# ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ç¢ºèª
check_requirements() {
    echo -e "${BLUE}ğŸ“‹ å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®ç¢ºèªä¸­...${NC}"
    
    if ! command -v docker &> /dev/null; then
        echo -e "${RED}âŒ DockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
        echo "https://docs.docker.com/get-docker/ ã‹ã‚‰Dockerã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
        exit 1
    fi
    
    if ! command -v docker-compose &> /dev/null; then
        echo -e "${RED}âŒ Docker ComposeãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“${NC}"
        echo "https://docs.docker.com/compose/install/ ã‹ã‚‰Docker Composeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… å¿…è¦ãªãƒ„ãƒ¼ãƒ«ãŒæƒã£ã¦ã„ã¾ã™${NC}"
}

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ç¢ºèªãƒ»ä½œæˆ
setup_env() {
    echo -e "${BLUE}ğŸ”§ ç’°å¢ƒå¤‰æ•°ã®è¨­å®šä¸­...${NC}"
    
    if [ ! -f .env ]; then
        echo -e "${YELLOW}âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚.env.exampleã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ã„ã¾ã™...${NC}"
        cp .env.example .env
        echo -e "${YELLOW}ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¦OpenAI APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„${NC}"
        echo -e "${YELLOW}   OPENAI_API_KEY=your_actual_api_key_here${NC}"
        
        # OpenAI APIã‚­ãƒ¼ã®å…¥åŠ›ã‚’ä¿ƒã™
        read -p "ä»Šã™ãOpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ (y/n): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            read -p "OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: " api_key
            if [ ! -z "$api_key" ]; then
                sed -i.bak "s/your_openai_api_key_here/$api_key/" .env
                echo -e "${GREEN}âœ… OpenAI APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ${NC}"
            fi
        fi
    else
        echo -e "${GREEN}âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ã¾ã™${NC}"
    fi
}

# Dockerç’°å¢ƒã®æ§‹ç¯‰
build_docker() {
    echo -e "${BLUE}ğŸ³ Dockerç’°å¢ƒã®æ§‹ç¯‰ä¸­...${NC}"
    
    # æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ãƒ»å‰Šé™¤
    echo "æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ä¸­..."
    docker-compose down -v 2>/dev/null || true
    
    # Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
    echo "Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
    docker-compose build --no-cache
    
    echo -e "${GREEN}âœ… Dockerç’°å¢ƒã®æ§‹ç¯‰å®Œäº†${NC}"
}

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–
init_database() {
    echo -e "${BLUE}ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ä¸­...${NC}"
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•
    echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•ä¸­..."
    docker-compose up -d db
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èµ·å‹•å¾…æ©Ÿ
    echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èµ·å‹•ã‚’å¾…æ©Ÿä¸­..."
    sleep 10
    
    # æ¥ç¶šãƒ†ã‚¹ãƒˆ
    max_attempts=30
    attempt=1
    while [ $attempt -le $max_attempts ]; do
        if docker-compose exec -T db pg_isready -U postgres > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã—ãŸ${NC}"
            break
        fi
        echo "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šè©¦è¡Œ $attempt/$max_attempts..."
        sleep 2
        attempt=$((attempt + 1))
    done
    
    if [ $attempt -gt $max_attempts ]; then
        echo -e "${RED}âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ${NC}"
        exit 1
    fi
}

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•
start_application() {
    echo -e "${BLUE}ğŸš€ ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®èµ·å‹•ä¸­...${NC}"
    
    # å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•
    docker-compose up -d
    
    # ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ç¢ºèª
    echo "ã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ç¢ºèªä¸­..."
    sleep 15
    
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®ç¢ºèª
    max_attempts=20
    attempt=1
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒèµ·å‹•ã—ã¾ã—ãŸ${NC}"
            break
        fi
        echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIèµ·å‹•ç¢ºèª $attempt/$max_attempts..."
        sleep 3
        attempt=$((attempt + 1))
    done
    
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç¢ºèª
    attempt=1
    while [ $attempt -le $max_attempts ]; do
        if curl -f http://localhost:3000 > /dev/null 2>&1; then
            echo -e "${GREEN}âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¾ã—ãŸ${NC}"
            break
        fi
        echo "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰èµ·å‹•ç¢ºèª $attempt/$max_attempts..."
        sleep 3
        attempt=$((attempt + 1))
    done
}

# æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
show_success() {
    echo -e "${GREEN}"
    echo "ğŸ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
    echo "==============================================="
    echo "ğŸŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: http://localhost:3000"
    echo "ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰API: http://localhost:8000"
    echo "ğŸ“Š APIæ–‡æ›¸: http://localhost:8000/docs"
    echo "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†: http://localhost:8080"
    echo "==============================================="
    echo ""
    echo "ğŸ“ ä½¿ç”¨æ–¹æ³•:"
    echo "  â€¢ ãƒ–ãƒ©ã‚¦ã‚¶ã§ http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹"
    echo "  â€¢ èˆˆå‘³ã®ã‚ã‚‹åˆ†é‡ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦æ¤œç´¢"
    echo "  â€¢ AIæ¨å¥¨ã‚·ã‚¹ãƒ†ãƒ ãŒé–¢é€£ç ”ç©¶å®¤ã‚’è¡¨ç¤º"
    echo ""
    echo "ğŸ› ï¸ ç®¡ç†ã‚³ãƒãƒ³ãƒ‰:"
    echo "  â€¢ åœæ­¢: docker-compose down"
    echo "  â€¢ å†èµ·å‹•: docker-compose restart"
    echo "  â€¢ ãƒ­ã‚°ç¢ºèª: docker-compose logs -f"
    echo "${NC}"
}

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
error_handler() {
    echo -e "${RED}âŒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ${NC}"
    echo "ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„: docker-compose logs"
    exit 1
}

trap error_handler ERR

# ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ
main() {
    echo -e "${BLUE}ç ”ç©¶å®¤ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆ${NC}"
    echo "============================================="
    
    check_requirements
    setup_env
    build_docker
    init_database
    start_application
    show_success
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@"

# === é–‹ç™ºç”¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
# scripts/run_dev.sh
#!/bin/bash

set -e

echo "ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰èµ·å‹•ä¸­..."

# ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
if [ ! -f .env ]; then
    echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
    echo "scripts/setup.sh ã‚’å…ˆã«å®Ÿè¡Œã—ã¦ãã ã•ã„"
    exit 1
fi

# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•
echo "ğŸš€ é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ä¸­..."
docker-compose up --build

# === ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
# scripts/build.sh
#!/bin/bash

set -e

echo "ğŸ—ï¸ ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ“ãƒ«ãƒ‰é–‹å§‹..."

# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ“ãƒ«ãƒ‰
echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
cd frontend
npm run build
cd ..

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ†ã‚¹ãƒˆ
echo "ğŸ§ª ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."
docker-compose -f docker-compose.yml -f docker-compose.test.yml run --rm backend pytest

echo "âœ… ãƒ“ãƒ«ãƒ‰å®Œäº†"

# === ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ ===
# scripts/reset_data.sh
#!/bin/bash

set -e

echo "ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒªã‚»ãƒƒãƒˆä¸­..."

# ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢
docker-compose down -v

# ãƒœãƒªãƒ¥ãƒ¼ãƒ ã®å‰Šé™¤
docker volume rm research_lab_finder_postgres_data 2>/dev/null || true

# å†èµ·å‹•
docker-compose up -d db

echo "âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ"
echo "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å†èµ·å‹•ã—ã¦ãã ã•ã„: docker-compose restart backend"